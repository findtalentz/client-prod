{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/get-session-from-token.ts"],"sourcesContent":["\"use server\";\n\nimport { jwtVerify } from \"jose\";\nimport { cookies } from \"next/headers\";\n\nexport type Session = {\n  _id: string;\n  role: \"SELLER\" | \"CLIENT\" | null;\n  emailStatus: \"UNVERIFIED\" | \"VERIFIED\";\n  identityStatus: \"UNVERIFIED\" | \"VERIFIED\" | \"PENDING\";\n  exp?: number;\n  iat?: number;\n};\n\nexport type SessionResult = {\n  session: Session;\n  token: string;\n} | null;\n\n/**\n * Professional session token validator with proper JWT verification\n */\nconst getSessionFromToken = async (): Promise<SessionResult> => {\n  try {\n    const cookieStore = await cookies();\n    const token = cookieStore.get(\"token\");\n\n    // No token found\n    if (!token?.value) {\n      return null;\n    }\n\n    // Validate JWT_SECRET exists\n    const jwtSecret = process.env.JWT_SECRET;\n    if (!jwtSecret) {\n      console.error(\"JWT_SECRET environment variable is not configured\");\n      return null;\n    }\n\n    // Verify token signature and decode\n    const secret = new TextEncoder().encode(jwtSecret);\n    const { payload } = await jwtVerify(token.value, secret);\n\n    // Validate token structure\n    if (!payload._id || !payload.emailStatus || !payload.identityStatus) {\n      console.error(\"Invalid token payload structure\");\n      return null;\n    }\n\n    const session = payload as Session;\n\n    // Check token expiration\n    const currentTime = Math.floor(Date.now() / 1000);\n    if (session.exp && session.exp < currentTime) {\n      console.warn(\"Token expired, clearing cookie\");\n      cookieStore.delete(\"token\");\n      return null;\n    }\n\n    return {\n      session,\n      token: token.value,\n    };\n  } catch (error: any) {\n    // Handle specific JWT errors\n    if (error.code === \"ERR_JWT_EXPIRED\") {\n      console.warn(\"JWT token expired\");\n    } else if (error.code === \"ERR_JWT_INVALID\") {\n      console.warn(\"Invalid JWT token\");\n    } else {\n      console.error(\"JWT verification error:\", error.message);\n    }\n\n    // Clear invalid token\n    try {\n      const cookieStore = await cookies();\n      cookieStore.delete(\"token\");\n    } catch (deleteError) {\n      console.error(\"Failed to clear invalid token:\", deleteError);\n    }\n\n    return null;\n  }\n};\n\nexport default getSessionFromToken;\n"],"names":[],"mappings":";;;;AAEA;AACA;AAAA;AAHA;;;AAmBA;;CAEC,GACD,MAAM,sBAAsB;IAC1B,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,sLAAO;QACjC,MAAM,QAAQ,YAAY,GAAG,CAAC;QAE9B,iBAAiB;QACjB,IAAI,CAAC,OAAO,OAAO;YACjB,OAAO;QACT;QAEA,6BAA6B;QAC7B,MAAM,YAAY,QAAQ,GAAG,CAAC,UAAU;QACxC,IAAI,CAAC,WAAW;YACd,QAAQ,KAAK,CAAC;YACd,OAAO;QACT;QAEA,oCAAoC;QACpC,MAAM,SAAS,IAAI,cAAc,MAAM,CAAC;QACxC,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,4KAAS,EAAC,MAAM,KAAK,EAAE;QAEjD,2BAA2B;QAC3B,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,WAAW,IAAI,CAAC,QAAQ,cAAc,EAAE;YACnE,QAAQ,KAAK,CAAC;YACd,OAAO;QACT;QAEA,MAAM,UAAU;QAEhB,yBAAyB;QACzB,MAAM,cAAc,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;QAC5C,IAAI,QAAQ,GAAG,IAAI,QAAQ,GAAG,GAAG,aAAa;YAC5C,QAAQ,IAAI,CAAC;YACb,YAAY,MAAM,CAAC;YACnB,OAAO;QACT;QAEA,OAAO;YACL;YACA,OAAO,MAAM,KAAK;QACpB;IACF,EAAE,OAAO,OAAY;QACnB,6BAA6B;QAC7B,IAAI,MAAM,IAAI,KAAK,mBAAmB;YACpC,QAAQ,IAAI,CAAC;QACf,OAAO,IAAI,MAAM,IAAI,KAAK,mBAAmB;YAC3C,QAAQ,IAAI,CAAC;QACf,OAAO;YACL,QAAQ,KAAK,CAAC,2BAA2B,MAAM,OAAO;QACxD;QAEA,sBAAsB;QACtB,IAAI;YACF,MAAM,cAAc,MAAM,IAAA,sLAAO;YACjC,YAAY,MAAM,CAAC;QACrB,EAAE,OAAO,aAAa;YACpB,QAAQ,KAAK,CAAC,kCAAkC;QAClD;QAEA,OAAO;IACT;AACF;uCAEe"}},
    {"offset": {"line": 86, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport getSessionFromToken, {\n  SessionResult,\n} from \"./actions/get-session-from-token\";\n\n// Constants\nconst PUBLIC_FILE = /\\.(.*)$/;\nconst LOCALES = [\"en\", \"ch\"] as const;\n/**\n * Get user locale from request\n */\nfunction getLocale(req: NextRequest): string {\n  const acceptLanguage = req.headers.get(\"accept-language\");\n  const primaryLang = acceptLanguage?.split(\",\")[0]?.split(\"-\")[0] || \"en\";\n  return LOCALES.includes(primaryLang as any) ? primaryLang : \"en\";\n}\n\n/**\n * Create localized redirect response\n */\nfunction redirectTo(req: NextRequest, path: string): NextResponse {\n  const locale = getLocale(req);\n  const url = new URL(`/${locale}${path}`, req.url);\n  return NextResponse.redirect(url);\n}\n\n/**\n * Check if redirect is needed to avoid unnecessary redirects\n */\nfunction shouldRedirect(req: NextRequest, targetPath: string): boolean {\n  const { pathname } = req.nextUrl;\n  const locale = getLocale(req);\n  const fullTargetPath = `/${locale}${targetPath}`;\n  return pathname !== fullTargetPath;\n}\n\n/**\n * Extract path without locale prefix\n */\nfunction getPathWithoutLocale(pathname: string): string {\n  const localeSegment = pathname.split(\"/\")[1];\n  const hasLocale = LOCALES.includes(localeSegment as any);\n  return hasLocale\n    ? pathname.replace(`/${localeSegment}`, \"\") || \"/\"\n    : pathname;\n}\n\n/**\n * Check if path matches any pattern\n */\nfunction pathMatches(path: string, patterns: RegExp[]): boolean {\n  return patterns.some((pattern) => pattern.test(path));\n}\n\nexport async function middleware(req: NextRequest) {\n  try {\n    const { pathname } = req.nextUrl;\n\n    // Skip public files\n    if (PUBLIC_FILE.test(pathname)) {\n      return NextResponse.next();\n    }\n\n    // Handle locale redirection\n    const hasLocale = LOCALES.some(\n      (locale) =>\n        pathname.startsWith(`/${locale}/`) || pathname === `/${locale}`\n    );\n\n    if (!hasLocale) {\n      const locale = getLocale(req);\n      const url = req.nextUrl.clone();\n      url.pathname = `/${locale}${pathname}`;\n      return NextResponse.redirect(url);\n    }\n\n    const currentLocale = pathname.split(\"/\")[1];\n    const pathWithoutLocale = getPathWithoutLocale(pathname);\n\n    // Get session data\n    const sessionData: SessionResult = await getSessionFromToken();\n\n    // Handle unauthenticated users\n    if (!sessionData) {\n      const isProtectedPath = pathMatches(pathWithoutLocale, [\n        /^\\/dashboard/,\n        /^\\/verify/,\n        /^\\/refer/,\n        /^\\/deposit-success/,\n        /^\\/profile/,\n        /^\\/role/,\n      ]);\n\n      if (isProtectedPath) {\n        if (shouldRedirect(req, \"/log-in\")) {\n          return redirectTo(req, \"/log-in\");\n        }\n      }\n      return NextResponse.next();\n    }\n\n    // User is authenticated - extract session data\n    const { session } = sessionData;\n    const { role, emailStatus, identityStatus } = session;\n\n    // Email verification flow\n    if (\n      emailStatus === \"UNVERIFIED\" &&\n      !pathWithoutLocale.startsWith(\"/email-verify\")\n    ) {\n      if (shouldRedirect(req, \"/email-verify\")) {\n        return redirectTo(req, \"/email-verify\");\n      }\n    }\n\n    if (\n      emailStatus === \"VERIFIED\" &&\n      pathWithoutLocale.startsWith(\"/email-verify\")\n    ) {\n      if (shouldRedirect(req, \"/dashboard\")) {\n        return redirectTo(req, \"/dashboard\");\n      }\n    }\n\n    // Identity verification flow\n    if (\n      identityStatus === \"VERIFIED\" &&\n      pathWithoutLocale.startsWith(\"/identity-verify\")\n    ) {\n      if (shouldRedirect(req, \"/dashboard\")) {\n        return redirectTo(req, \"/dashboard\");\n      }\n    }\n\n    // Role selection flow\n    if (\n      !role &&\n      pathMatches(pathWithoutLocale, [/^\\/dashboard/, /^\\/profile/])\n    ) {\n      if (shouldRedirect(req, \"/role\")) {\n        return redirectTo(req, \"/role\");\n      }\n    }\n\n    if (role && pathWithoutLocale.startsWith(\"/role\")) {\n      if (shouldRedirect(req, \"/dashboard\")) {\n        return redirectTo(req, \"/dashboard\");\n      }\n    }\n\n    // Role-based access control\n    if (role === \"CLIENT\" && pathWithoutLocale.startsWith(\"/seller\")) {\n      if (shouldRedirect(req, \"/dashboard/client\")) {\n        return redirectTo(req, \"/dashboard/client\");\n      }\n    }\n\n    if (role === \"SELLER\" && pathWithoutLocale.startsWith(\"/client\")) {\n      if (shouldRedirect(req, \"/dashboard/seller\")) {\n        return redirectTo(req, \"/dashboard/seller\");\n      }\n    }\n\n    // Prevent authenticated users from accessing auth pages\n    if (pathMatches(pathWithoutLocale, [/^\\/log-in/, /^\\/sign-up/])) {\n      if (shouldRedirect(req, \"/dashboard\")) {\n        return redirectTo(req, \"/dashboard\");\n      }\n    }\n\n    // Add security headers for authenticated routes\n    if (pathWithoutLocale.startsWith(\"/dashboard\")) {\n      const response = NextResponse.next();\n      response.headers.set(\"X-Frame-Options\", \"DENY\");\n      response.headers.set(\"X-Content-Type-Options\", \"nosniff\");\n      return response;\n    }\n\n    return NextResponse.next();\n  } catch (error) {\n    console.error(\"Middleware execution error:\", error);\n\n    // Don't redirect to error page if we're already there\n    if (!req.nextUrl.pathname.includes(\"/error\")) {\n      return redirectTo(req, \"/error\");\n    }\n\n    return NextResponse.next();\n  }\n}\n\nexport const config = {\n  matcher: [\n    \"/((?!api|_next/static|_next/image|favicon.ico|sw.js|site.webmanifest).*)\",\n  ],\n};\n"],"names":[],"mappings":"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"}}]
}